name = "safework2-api"
main = "src/index.ts"
compatibility_date = "2024-12-30"
compatibility_flags = ["nodejs_compat_v2"]
workers_dev = true

# Custom domain routes (requires Zone permissions in API token)
# Uncomment when custom domain is configured via Cloudflare dashboard
# routes = [
#   { pattern = "safework2.jclee.me/*", zone_name = "jclee.me" }
# ]

[vars]
ENVIRONMENT = "production"
REQUIRE_ATTENDANCE_FOR_LOGIN = "false"
REQUIRE_ATTENDANCE_FOR_POST = "false"

# Required secrets — use .dev.vars for local dev, `wrangler secret put <NAME>` for production:
#   JWT_SECRET          — JWT signing key
#   HMAC_SECRET         — HMAC-SHA256 for PII hashing
#   ENCRYPTION_KEY      — AES encryption for phone/DOB
#   ALERT_WEBHOOK_URL   — Webhook URL for operational alerts (cron failures, FAS down)
#   FAS_SYNC_SECRET     — Bearer secret for POST /fas-sync admin endpoint
#   ELASTICSEARCH_URL   — Elasticsearch endpoint (production only)

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "safework2-db"
database_id = "9d62c0d4-b264-4378-8219-da540f35d9d9"

# R2 Bucket for images
[[r2_buckets]]
binding = "R2"
bucket_name = "safework2-images"

# R2 Bucket for static frontend files
[[r2_buckets]]
binding = "STATIC"
bucket_name = "safework2-static"

# R2 Bucket for AceTime data (photos + DB from NAS)
[[r2_buckets]]
binding = "ACETIME_BUCKET"
bucket_name = "safework2-acetime"

# Hyperdrive — FAS MariaDB via Cloudflare Tunnel
[[hyperdrive]]
binding = "FAS_HYPERDRIVE"
id = "83c32c884d3b42b18c4b0601c0e2e0dc"
localConnectionString = "postgresql://root:root@localhost:5432/fas_local"

# KV Namespace for cache/sessions
[[kv_namespaces]]
binding = "KV"
id = "57ab28dca9dd4193a8f59f93e57122d8"

# Analytics Engine for observability
[[analytics_engine_datasets]]
binding = "ANALYTICS"

# Cloudflare Queue for reliable notification delivery
[[queues.producers]]
queue = "safework2-notifications"
binding = "NOTIFICATION_QUEUE"

[[queues.consumers]]
queue = "safework2-notifications"
max_batch_size = 10
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "safework2-notifications-dlq"

# Workers AI for hazard classification and privacy features
[ai]
binding = "AI"

# Workers Logs observability
[observability]
enabled = true
head_sampling_rate = 1

# Durable Objects for rate limiting
[durable_objects]
bindings = [
  { name = "RATE_LIMITER", class_name = "RateLimiter" }
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["RateLimiter"]


[triggers]
crons = ["*/5 * * * *", "0 0 1 * *", "0 3 * * SUN", "0 21 * * *"]

# Development Environment
[env.dev]
name = "safework2-api-dev"

[env.dev.vars]
ENVIRONMENT = "development"
REQUIRE_ATTENDANCE_FOR_LOGIN = "false"
REQUIRE_ATTENDANCE_FOR_POST = "false"
ELASTICSEARCH_URL = "http://192.168.50.105:9200"

# Required secrets — use .dev.vars for local dev, `wrangler secret put <NAME> --env dev` for staging:
#   JWT_SECRET / HMAC_SECRET / ENCRYPTION_KEY / ALERT_WEBHOOK_URL / FAS_SYNC_SECRET

[[env.dev.d1_databases]]
binding = "DB"
database_name = "safework2-db-dev"
database_id = "edeb67f3-0135-4ccc-bf5c-dd1914460b06"

[[env.dev.r2_buckets]]
binding = "R2"
bucket_name = "safework2-images"

[[env.dev.r2_buckets]]
binding = "STATIC"
bucket_name = "safework2-static"

[[env.dev.r2_buckets]]
binding = "ACETIME_BUCKET"
bucket_name = "safework2-acetime"

[[env.dev.hyperdrive]]
binding = "FAS_HYPERDRIVE"
id = "83c32c884d3b42b18c4b0601c0e2e0dc"
localConnectionString = "postgresql://root:root@localhost:5432/fas_local"

[[env.dev.kv_namespaces]]
binding = "KV"
id = "57ab28dca9dd4193a8f59f93e57122d8"

[[env.dev.analytics_engine_datasets]]
binding = "ANALYTICS"

[env.dev.ai]
binding = "AI"

[env.dev.observability]
enabled = true
head_sampling_rate = 1

[env.dev.durable_objects]
bindings = [
  { name = "RATE_LIMITER", class_name = "RateLimiter" }
]

[[env.dev.queues.producers]]
queue = "safework2-notifications"
binding = "NOTIFICATION_QUEUE"

[[env.dev.queues.consumers]]
queue = "safework2-notifications"
max_batch_size = 10
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "safework2-notifications-dlq"

