generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  WORKER
  SITE_ADMIN
  SUPER_ADMIN
  SYSTEM
}

enum MembershipStatus {
  PENDING
  ACTIVE
  LEFT
  REMOVED
}

enum MembershipRole {
  WORKER
  SITE_ADMIN
}

enum Category {
  HAZARD
  UNSAFE_BEHAVIOR
  INCONVENIENCE
  SUGGESTION
  BEST_PRACTICE
}

enum RiskLevel {
  HIGH
  MEDIUM
  LOW
}

enum Visibility {
  WORKER_PUBLIC
  ADMIN_ONLY
}

enum ReviewStatus {
  RECEIVED
  IN_REVIEW
  NEED_INFO
  APPROVED
  REJECTED
}

enum ActionStatus {
  NONE
  REQUIRED
  ASSIGNED
  IN_PROGRESS
  DONE
  REOPENED
}

enum ReviewAction {
  APPROVE
  REJECT
  REQUEST_MORE
  MARK_URGENT
  ASSIGN
  CLOSE
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
}

enum AttendanceResult {
  SUCCESS
  FAIL
}

enum AttendanceSource {
  FAS
  MANUAL
}

enum VoteCandidateSource {
  ADMIN
  AUTO
}

model User {
  id                String    @id @default(cuid())
  phone             String    @unique
  phoneHash         String?   @map("phone_hash")
  name              String?
  nameMasked        String?   @map("name_masked")
  dob               String?
  dobHash           String?   @map("dob_hash")
  externalSystem    String?   @map("external_system")
  externalWorkerId  String?   @map("external_worker_id")
  companyName       String?   @map("company_name")
  tradeType         String?   @map("trade_type")
  role              UserRole  @default(WORKER)
  piiViewFull       Boolean   @default(false) @map("pii_view_full")
  canAwardPoints    Boolean   @default(false) @map("can_award_points")
  canManageUsers    Boolean   @default(false) @map("can_manage_users")
  otpCode           String?   @map("otp_code")
  otpExpiresAt      DateTime? @map("otp_expires_at")
  otpAttemptCount   Int       @default(0) @map("otp_attempt_count")
  refreshToken      String?   @map("refresh_token")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  memberships      SiteMembership[]
  posts            Post[]
  reviews          Review[]         @relation("ReviewAdmin")
  pointsGiven      PointsLedger[]   @relation("PointsAdmin")
  pointsReceived   PointsLedger[]   @relation("PointsUser")
  auditLogs        AuditLog[]
  announcements    Announcement[]
  sessions         Session[]
  actions          Action[]
  attendances      Attendance[]
  votesGiven       Vote[]           @relation("VoteVoter")
  votesReceived    Vote[]           @relation("VoteCandidate")
  votesCandidacy   VoteCandidate[]
  approvalsGiven   ManualApproval[] @relation("ApprovalAdmin")
  approvalsReceived ManualApproval[] @relation("ApprovalUser")

  @@index([phoneHash, dobHash])
  @@index([externalSystem, externalWorkerId])
  @@map("users")
}

model Site {
  id               String    @id @default(cuid())
  name             String
  joinCode         String    @unique @map("join_code")
  active           Boolean   @default(true)
  joinEnabled      Boolean   @default(true) @map("join_enabled")
  requiresApproval Boolean   @default(false) @map("requires_approval")
  createdAt        DateTime  @default(now()) @map("created_at")
  closedAt         DateTime? @map("closed_at")

  memberships     SiteMembership[]
  posts           Post[]
  pointsLedger    PointsLedger[]
  announcements   Announcement[]
  attendances     Attendance[]
  accessPolicy    AccessPolicy?
  manualApprovals ManualApproval[]
  votes           Vote[]
  voteCandidates  VoteCandidate[]

  @@map("sites")
}

model SiteMembership {
  id         String           @id @default(cuid())
  userId     String           @map("user_id")
  siteId     String           @map("site_id")
  role       MembershipRole   @default(WORKER)
  status     MembershipStatus @default(PENDING)
  joinedAt   DateTime         @default(now()) @map("joined_at")
  leftAt     DateTime?        @map("left_at")
  leftReason String?          @map("left_reason")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([userId, siteId])
  @@index([siteId, status])
  @@map("site_memberships")
}

model Post {
  id             String       @id @default(cuid())
  userId         String       @map("user_id")
  siteId         String       @map("site_id")
  category       Category
  hazardType     String?      @map("hazard_type")
  riskLevel      RiskLevel?   @map("risk_level")
  locationFloor  String?      @map("location_floor")
  locationZone   String?      @map("location_zone")
  locationDetail String?      @map("location_detail")
  content        String
  visibility     Visibility   @default(WORKER_PUBLIC)
  isAnonymous    Boolean      @default(false) @map("is_anonymous")
  reviewStatus   ReviewStatus @default(RECEIVED) @map("review_status")
  actionStatus   ActionStatus @default(NONE) @map("action_status")
  isUrgent       Boolean      @default(false) @map("is_urgent")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  site         Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)
  images       PostImage[]
  reviews      Review[]
  pointsLedger PointsLedger[]
  actions      Action[]

  @@index([siteId, reviewStatus])
  @@index([siteId, createdAt])
  @@index([userId, createdAt])
  @@map("posts")
}

model PostImage {
  id           String   @id @default(cuid())
  postId       String   @map("post_id")
  fileUrl      String   @map("file_url")
  thumbnailUrl String?  @map("thumbnail_url")
  createdAt    DateTime @default(now()) @map("created_at")

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("post_images")
}

model Review {
  id         String       @id @default(cuid())
  postId     String       @map("post_id")
  adminId    String       @map("admin_id")
  action     ReviewAction
  comment    String?
  reasonCode String?      @map("reason_code")
  createdAt  DateTime     @default(now()) @map("created_at")

  post  Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  admin User @relation("ReviewAdmin", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@map("reviews")
}

model PointsLedger {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  siteId       String   @map("site_id")
  postId       String?  @map("post_id")
  refLedgerId  String?  @map("ref_ledger_id")
  amount       Int
  reasonCode   String   @map("reason_code")
  reasonText   String?  @map("reason_text")
  adminId      String?  @map("admin_id")
  settleMonth  String   @map("settle_month")
  occurredAt   DateTime @default(now()) @map("occurred_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user      User          @relation("PointsUser", fields: [userId], references: [id], onDelete: Cascade)
  site      Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  post      Post?         @relation(fields: [postId], references: [id], onDelete: SetNull)
  admin     User?         @relation("PointsAdmin", fields: [adminId], references: [id], onDelete: SetNull)
  refLedger PointsLedger? @relation("PointsAdjustment", fields: [refLedgerId], references: [id], onDelete: SetNull)
  adjustments PointsLedger[] @relation("PointsAdjustment")

  @@index([userId, siteId, settleMonth])
  @@index([siteId, settleMonth])
  @@map("points_ledger")
}

model Action {
  id             String     @id @default(cuid())
  postId         String     @map("post_id")
  assigneeType   String     @map("assignee_type")
  assigneeId     String?    @map("assignee_id")
  dueDate        DateTime?  @map("due_date")
  actionStatus   TaskStatus @default(OPEN) @map("action_status")
  completionNote String?    @map("completion_note")
  completedAt    DateTime?  @map("completed_at")
  createdAt      DateTime   @default(now()) @map("created_at")

  post     Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  assignee User?         @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  images   ActionImage[]

  @@index([postId])
  @@map("actions")
}

model ActionImage {
  id           String   @id @default(cuid())
  actionId     String   @map("action_id")
  fileUrl      String   @map("file_url")
  thumbnailUrl String?  @map("thumbnail_url")
  createdAt    DateTime @default(now()) @map("created_at")

  action Action @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@map("action_images")
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String   @map("actor_id")
  action     String
  targetType String   @map("target_type")
  targetId   String   @map("target_id")
  reason     String?
  ip         String?
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  actor User @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId, createdAt])
  @@index([targetType, targetId])
  @@map("audit_logs")
}

model Announcement {
  id        String   @id @default(cuid())
  siteId    String   @map("site_id")
  authorId  String   @map("author_id")
  title     String
  content   String
  isPinned  Boolean  @default(false) @map("is_pinned")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  site   Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([siteId, isPinned, createdAt])
  @@map("announcements")
}

model Session {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  refreshToken String   @unique @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Attendance {
  id               String           @id @default(cuid())
  siteId           String           @map("site_id")
  userId           String?          @map("user_id")
  externalWorkerId String?          @map("external_worker_id")
  checkinAt        DateTime         @map("checkin_at")
  result           AttendanceResult
  deviceId         String?          @map("device_id")
  source           AttendanceSource
  createdAt        DateTime         @default(now()) @map("created_at")

  site Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([siteId, checkinAt])
  @@index([userId, checkinAt])
  @@index([externalWorkerId, checkinAt])
  @@map("attendances")
}

model AccessPolicy {
  id             String   @id @default(cuid())
  siteId         String   @unique @map("site_id")
  requireCheckin Boolean  @default(true) @map("require_checkin")
  dayCutoffHour  Int      @default(5) @map("day_cutoff_hour")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@map("access_policies")
}

model ManualApproval {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  siteId       String   @map("site_id")
  approvedById String   @map("approved_by_id")
  reason       String
  validDate    DateTime @map("valid_date")
  approvedAt   DateTime @default(now()) @map("approved_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user       User @relation("ApprovalUser", fields: [userId], references: [id], onDelete: Cascade)
  approvedBy User @relation("ApprovalAdmin", fields: [approvedById], references: [id], onDelete: Cascade)
  site       Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([userId, validDate])
  @@index([siteId, validDate])
  @@map("manual_approvals")
}

model Vote {
  id          String   @id @default(cuid())
  siteId      String   @map("site_id")
  month       String
  voterId     String   @map("voter_id")
  candidateId String   @map("candidate_id")
  votedAt     DateTime @default(now()) @map("voted_at")

  site      Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  voter     User @relation("VoteVoter", fields: [voterId], references: [id], onDelete: Cascade)
  candidate User @relation("VoteCandidate", fields: [candidateId], references: [id], onDelete: Cascade)

  @@unique([siteId, month, voterId])
  @@index([siteId, month])
  @@map("votes")
}

model VoteCandidate {
  id        String              @id @default(cuid())
  siteId    String              @map("site_id")
  month     String
  userId    String              @map("user_id")
  source    VoteCandidateSource
  createdAt DateTime            @default(now()) @map("created_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([siteId, month, userId])
  @@index([siteId, month])
  @@map("vote_candidates")
}
