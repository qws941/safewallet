name: Deployment Monitoring

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: read
  issues: write

jobs:
  monitor:
    name: Endpoint Health Monitor
    runs-on: ubuntu-latest
    outputs:
      failure_count: ${{ steps.health.outputs.failure_count }}
      report_path: ${{ steps.health.outputs.report_path }}
    steps:
      - name: Check production endpoints
        id: health
        run: |
          REPORT_FILE="deploy-monitor-report.md"
          FAILED=0
          STARTED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          check_endpoint() {
            name="$1"
            url="$2"
            expected="$3"
            fallback_url="$4"

            result=$(curl -sS -o /tmp/monitor_body -w "%{http_code} %{time_total}" \
              --max-time 20 --retry 2 --retry-delay 2 --location \
              --user-agent "Mozilla/5.0 (compatible; SafeWalletDeployMonitor/1.0)" \
              -H "Accept: text/html,application/json;q=0.9,*/*;q=0.8" \
              "$url" || echo "000 999")
            status=$(echo "$result" | cut -d' ' -f1)
            latency=$(echo "$result" | cut -d' ' -f2)

            if [ "$status" = "$expected" ]; then
              echo "- [OK] $name | status=$status | latency=${latency}s | $url" >> "$REPORT_FILE"
            elif [ -n "$fallback_url" ]; then
              fallback_result=$(curl -sS -o /tmp/monitor_body -w "%{http_code} %{time_total}" \
                --max-time 20 --retry 2 --retry-delay 2 --location \
                --user-agent "Mozilla/5.0 (compatible; SafeWalletDeployMonitor/1.0)" \
                -H "Accept: text/html,application/json;q=0.9,*/*;q=0.8" \
                "$fallback_url" || echo "000 999")
              fallback_status=$(echo "$fallback_result" | cut -d' ' -f1)
              fallback_latency=$(echo "$fallback_result" | cut -d' ' -f2)

              if [ "$fallback_status" = "$expected" ] && [ "$status" = "403" ]; then
                echo "- [OK] $name | custom-domain status=403 (runner blocked), fallback status=$fallback_status | fallback latency=${fallback_latency}s | $fallback_url" >> "$REPORT_FILE"
              else
                FAILED=$((FAILED + 1))
                echo "- [FAIL] $name | status=$status | expected=$expected | latency=${latency}s | $url" >> "$REPORT_FILE"
                echo "  - fallback status=$fallback_status | expected=$expected | latency=${fallback_latency}s | $fallback_url" >> "$REPORT_FILE"
              fi
            else
              FAILED=$((FAILED + 1))
              echo "- [FAIL] $name | status=$status | expected=$expected | latency=${latency}s | $url" >> "$REPORT_FILE"
            fi
          }

          {
            echo "# Deployment Monitor Report"
            echo ""
            echo "- Run started (UTC): $STARTED_AT"
            echo ""
            echo "## Endpoint Results"
          } > "$REPORT_FILE"

          check_endpoint "Worker App" "https://safewallet.jclee.me" "200" "https://safewallet.jclee.workers.dev"
          check_endpoint "Admin App" "https://admin.safewallet.jclee.me" "200" "https://safewallet.jclee.workers.dev/admin"
          check_endpoint "API Health" "https://safewallet.jclee.me/api/health" "200" "https://safewallet.jclee.workers.dev/api/health"

          echo "" >> "$REPORT_FILE"
          echo "- Failure count: $FAILED" >> "$REPORT_FILE"

          echo "failure_count=$FAILED" >> "$GITHUB_OUTPUT"
          echo "report_path=$REPORT_FILE" >> "$GITHUB_OUTPUT"

      - name: Upload monitor report
        uses: actions/upload-artifact@v6
        with:
          name: deploy-monitor-report
          path: ${{ steps.health.outputs.report_path }}
          retention-days: 7

      - name: Notify webhook (optional)
        if: steps.health.outputs.failure_count != '0'
        env:
          DEPLOY_MONITOR_WEBHOOK_URL: ${{ secrets.DEPLOY_MONITOR_WEBHOOK_URL || secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$DEPLOY_MONITOR_WEBHOOK_URL" ]; then
            echo "Webhook URL not configured. Skipping notification."
            exit 0
          fi
          payload=$(printf '{"text":"[Deploy Monitor] %s failure(s) detected on safewallet production. Run: %s"}' \
            "${{ steps.health.outputs.failure_count }}" "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}")
          if ! curl -sS --fail-with-body --retry 3 --retry-all-errors --retry-delay 2 --max-time 30 -X POST "$DEPLOY_MONITOR_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$payload"; then
            echo "::warning::Failed to deliver deploy-monitor webhook notification"
          fi

  incident:
    name: Upsert Incident Issue on Failure
    runs-on: ubuntu-latest
    needs: monitor
    if: needs.monitor.outputs.failure_count != '0'
    steps:
      - name: Upsert incident issue
        uses: actions/github-script@v8
        with:
          script: |
            const failures = `${{ needs.monitor.outputs.failure_count }}`;
            const title = `[Deploy Monitor] ${failures} endpoint failure(s)`;
            const body = [
              'Automated deployment monitor detected production endpoint failure(s).',
              '',
              `- Failures: ${failures}`,
              `- Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              '',
              'Please investigate deployment health and rollback if needed.'
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const existing = issues.find((issue) => issue.title.startsWith('[Deploy Monitor]'));

            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                title,
                body
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `Repeated failure detected: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body
              });
            }

      - name: Mark workflow failed
        run: |
          echo "Deployment monitoring detected failures"
          exit 1

  recovery:
    name: Close Incident on Recovery
    runs-on: ubuntu-latest
    needs: monitor
    if: needs.monitor.outputs.failure_count == '0'
    steps:
      - name: Close open deploy-monitor incidents
        uses: actions/github-script@v8
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const incidents = issues.filter((issue) => issue.title.startsWith('[Deploy Monitor]'));

            for (const issue of incidents) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Recovery detected: all monitored endpoints healthy in run ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}.`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
