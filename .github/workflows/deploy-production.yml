name: Deploy SafeWork2

on:
  workflow_run:
    workflows: ["CI"]
    branches: [master]
    types: [completed]

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  NODE_VERSION: "20"

jobs:
  resolve-sha:
    name: Resolve Deployment SHA
    runs-on: ubuntu-latest
    outputs:
      deploy-sha: ${{ steps.sha.outputs.deploy_sha }}
    steps:
      - name: Select source commit
        id: sha
        run: |
          DEPLOY_SHA="${{ github.event.workflow_run.head_sha }}"
          echo "deploy_sha=$DEPLOY_SHA" >> "$GITHUB_OUTPUT"
          echo "Deploy source SHA: $DEPLOY_SHA"

  verify-before-deploy:
    name: Verify Production Before Deploy
    needs: [resolve-sha]
    if: github.event.workflow_run.conclusion == 'success'
    uses: ./.github/workflows/deploy-verify.yml
    with:
      environment: production
      ref: ${{ needs.resolve-sha.outputs.deploy-sha }}
    secrets: inherit

  deploy-api-worker:
    name: Deploy API Worker (Single Worker Mode)
    runs-on: ubuntu-latest
    needs: [resolve-sha, verify-before-deploy]
    if: github.event.workflow_run.conclusion == 'success'
    environment: production
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.resolve-sha.outputs.deploy-sha }}

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build shared packages
        run: npm run build --workspace=packages/types

      - name: Build worker-app (static export)
        run: npm run build --workspace=apps/worker-app

      - name: Build admin-app (static export)
        run: npm run build --workspace=apps/admin-app

      - name: Sync worker-app static assets to R2
        working-directory: apps/worker-app
        run: |
          get_ct() {
            case "${1##*.}" in
              html) echo "text/html";;
              css)  echo "text/css";;
              js)   echo "application/javascript";;
              json) echo "application/json";;
              png)  echo "image/png";;
              jpg|jpeg) echo "image/jpeg";;
              gif)  echo "image/gif";;
              svg)  echo "image/svg+xml";;
              ico)  echo "image/x-icon";;
              woff) echo "font/woff";;
              woff2) echo "font/woff2";;
              ttf)  echo "font/ttf";;
              webp) echo "image/webp";;
              webmanifest) echo "application/manifest+json";;
              xml)  echo "application/xml";;
              txt)  echo "text/plain";;
              *)    echo "application/octet-stream";;
            esac
          }
          find out -type f | while IFS= read -r file; do
            key="${file#out/}"
            ct=$(get_ct "$file")
            npx wrangler r2 object put "safework2-static/$key" --file="$file" --content-type="$ct" --remote
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN_API || secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Sync admin-app static assets to R2
        working-directory: apps/admin-app
        run: |
          get_ct() {
            case "${1##*.}" in
              html) echo "text/html";;
              css)  echo "text/css";;
              js)   echo "application/javascript";;
              json) echo "application/json";;
              png)  echo "image/png";;
              jpg|jpeg) echo "image/jpeg";;
              gif)  echo "image/gif";;
              svg)  echo "image/svg+xml";;
              ico)  echo "image/x-icon";;
              woff) echo "font/woff";;
              woff2) echo "font/woff2";;
              ttf)  echo "font/ttf";;
              webp) echo "image/webp";;
              webmanifest) echo "application/manifest+json";;
              xml)  echo "application/xml";;
              txt)  echo "text/plain";;
              *)    echo "application/octet-stream";;
            esac
          }
          find out -type f | while IFS= read -r file; do
            key="admin/${file#out/}"
            ct=$(get_ct "$file")
            npx wrangler r2 object put "safework2-static/$key" --file="$file" --content-type="$ct" --remote
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN_API || secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Validate API Worker bundle
        run: npm run build --workspace=apps/api-worker

      - name: Deploy API Worker
        working-directory: apps/api-worker
        run: npx wrangler deploy --env=""
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN_API || secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  verify-production:
    name: Verify Production After Deploy
    needs: [resolve-sha, deploy-api-worker]
    uses: ./.github/workflows/deploy-verify.yml
    with:
      environment: production
      ref: ${{ needs.resolve-sha.outputs.deploy-sha }}
    secrets: inherit

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [verify-before-deploy, deploy-api-worker, verify-production]
    if: always() && !cancelled()
    steps:
      - name: Send deploy status to Slack (optional)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || secrets.DEPLOY_MONITOR_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          VERIFY_BEFORE_RESULT: ${{ needs.verify-before-deploy.result }}
          API_RESULT: ${{ needs.deploy-api-worker.result }}
          VERIFY_RESULT: ${{ needs.verify-production.result }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured. Skipping notification."
            exit 0
          fi

          status="SUCCESS"
          icon=":white_check_mark:"
          color="#2eb886"

          if [ "$VERIFY_BEFORE_RESULT" = "failure" ] || [ "$API_RESULT" = "failure" ] || [ "$VERIFY_RESULT" = "failure" ]; then
            status="FAILED"
            icon=":x:"
            color="#d40e0d"
          elif [ "$VERIFY_BEFORE_RESULT" = "cancelled" ] || [ "$API_RESULT" = "cancelled" ] || [ "$VERIFY_RESULT" = "cancelled" ]; then
            status="CANCELLED"
            icon=":warning:"
            color="#daa038"
          fi

          payload=$(printf '{"attachments":[{"color":"%s","text":"%s Production deploy %s\\n- Verify before deploy: %s\\n- API Worker: %s\\n- Verify after deploy: %s\\n- Run: %s"}]}' \
            "$color" "$icon" "$status" "$VERIFY_BEFORE_RESULT" "$API_RESULT" "$VERIFY_RESULT" "$RUN_URL")

          if ! curl -sS --fail-with-body --retry 3 --retry-all-errors --retry-delay 2 --max-time 30 -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$payload"; then
            echo "::warning::Failed to deliver deploy Slack notification"
          fi
