name: Deploy SafeWallet

on:
  workflow_run:
    workflows: ["CI"]
    branches: [master]
    types: [completed]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to verify after Cloudflare Git Integration deploy"
        required: false
        default: "master"

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  resolve-sha:
    name: Resolve Deployment SHA
    if: >-
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      deploy-sha: ${{ steps.sha.outputs.deploy_sha }}
      deploy-ref: ${{ steps.sha.outputs.deploy_ref }}
    steps:
      - uses: actions/checkout@v6
      - name: Select source commit
        id: sha
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            DEPLOY_REF="${{ github.event.workflow_run.head_branch }}"
            DEPLOY_SHA="${{ github.event.workflow_run.head_sha }}"
          else
            DEPLOY_REF="${{ inputs.ref || github.ref_name }}"
            git fetch --force --tags origin
            if git rev-parse --verify "${DEPLOY_REF}^{commit}" >/dev/null 2>&1; then
              DEPLOY_SHA="$(git rev-parse "${DEPLOY_REF}^{commit}")"
            elif git rev-parse --verify "origin/${DEPLOY_REF}^{commit}" >/dev/null 2>&1; then
              DEPLOY_SHA="$(git rev-parse "origin/${DEPLOY_REF}^{commit}")"
            else
              echo "::error::Unable to resolve deploy ref: ${DEPLOY_REF}"
              exit 1
            fi
          fi

          echo "deploy_ref=$DEPLOY_REF" >> "$GITHUB_OUTPUT"
          echo "deploy_sha=$DEPLOY_SHA" >> "$GITHUB_OUTPUT"
          echo "Deploy source ref: $DEPLOY_REF"
          echo "Deploy source SHA: $DEPLOY_SHA"

  wait-for-cloudflare-build:
    name: Wait for Cloudflare Git Integration Deploy
    needs: [resolve-sha]
    runs-on: ubuntu-latest
    steps:
      - name: Wait until production API responds healthy
        run: |
          for i in $(seq 1 30); do
            code=$(curl -sS -o /tmp/health.json -w "%{http_code}" --max-time 10 https://safewallet.jclee.workers.dev/api/health || true)
            if [ "$code" = "200" ] && grep -Eq '"status"[[:space:]]*:[[:space:]]*"healthy"' /tmp/health.json; then
              echo "Cloudflare deployment appears available"
              exit 0
            fi
            echo "Waiting for Cloudflare deploy... attempt $i/30"
            sleep 20
          done
          echo "::error::Timed out waiting for production health endpoint"
          exit 1

  verify-production:
    name: Verify Production After Git Integration Deploy
    needs: [resolve-sha, wait-for-cloudflare-build]
    uses: ./.github/workflows/deploy-verify.yml
    with:
      environment: production
      ref: ${{ needs.resolve-sha.outputs.deploy-sha }}
    secrets: inherit

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [verify-production]
    if: always() && !cancelled()
    steps:
      - name: Send deploy status to Slack (optional)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || secrets.DEPLOY_MONITOR_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          VERIFY_RESULT: ${{ needs.verify-production.result }}
          DEPLOY_REF: ${{ needs.resolve-sha.outputs.deploy-ref }}
          DEPLOY_SHA: ${{ needs.resolve-sha.outputs.deploy-sha }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured. Skipping notification."
            exit 0
          fi

          status="SUCCESS"
          icon=":white_check_mark:"
          color="#2eb886"
          if [ "$VERIFY_RESULT" = "failure" ]; then
            status="FAILED"
            icon=":x:"
            color="#d40e0d"
          elif [ "$VERIFY_RESULT" = "cancelled" ]; then
            status="CANCELLED"
            icon=":warning:"
            color="#daa038"
          elif [ "$VERIFY_RESULT" = "skipped" ]; then
            status="SKIPPED"
            icon=":warning:"
            color="#daa038"
          fi

          payload=$(printf '{"attachments":[{"color":"%s","text":"%s Production deploy verification (%s)\n- Ref: %s\n- SHA: %s\n- Verify: %s\n- Run: %s"}]}' \
            "$color" "$icon" "$status" "$DEPLOY_REF" "$DEPLOY_SHA" "$VERIFY_RESULT" "$RUN_URL")

          if ! curl -sS --fail-with-body --retry 3 --retry-all-errors --retry-delay 2 --max-time 30 -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$payload"; then
            echo "::warning::Failed to deliver deploy Slack notification"
          fi
