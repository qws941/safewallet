name: Deploy SafeWork2

on:
  workflow_run:
    workflows: ["CI"]
    branches: [master]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  NODE_VERSION: "20"

jobs:
  resolve-sha:
    name: Resolve Deployment SHA
    runs-on: ubuntu-latest
    outputs:
      deploy-sha: ${{ steps.sha.outputs.deploy_sha }}
    steps:
      - name: Select source commit
        id: sha
        run: |
          DEPLOY_SHA="${{ github.event.workflow_run.head_sha || github.sha }}"
          echo "deploy_sha=$DEPLOY_SHA" >> "$GITHUB_OUTPUT"
          echo "Deploy source SHA: $DEPLOY_SHA"

  deploy-api-worker:
    name: Deploy API Worker (Single Worker Mode)
    runs-on: ubuntu-latest
    needs: resolve-sha
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    environment: production
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.resolve-sha.outputs.deploy-sha }}

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build shared types
        run: npm run build --workspace=packages/types

      - name: Validate API Worker bundle
        run: npm run build --workspace=apps/api-worker

      - name: Deploy API Worker
        working-directory: apps/api-worker
        run: npx wrangler deploy --env=""
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN_API || secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [deploy-api-worker]
    if: always() && !cancelled()
    steps:
      - name: Send deploy status to Slack (optional)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || secrets.DEPLOY_MONITOR_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          API_RESULT: ${{ needs.deploy-api-worker.result }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured. Skipping notification."
            exit 0
          fi

          status="SUCCESS"
          icon=":white_check_mark:"
          color="#2eb886"

          if [ "$API_RESULT" = "failure" ]; then
            status="FAILED"
            icon=":x:"
            color="#d40e0d"
          elif [ "$API_RESULT" = "cancelled" ]; then
            status="CANCELLED"
            icon=":warning:"
            color="#daa038"
          fi

          payload=$(printf '{"attachments":[{"color":"%s","text":"%s Production deploy %s\\n- API Worker: %s\\n- Run: %s"}]}' \
            "$color" "$icon" "$status" "$API_RESULT" "$RUN_URL")

          if ! curl -sS --fail-with-body --retry 3 --retry-all-errors --retry-delay 2 --max-time 30 -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$payload"; then
            echo "::warning::Failed to deliver deploy Slack notification"
          fi
